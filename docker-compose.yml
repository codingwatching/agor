# Agor Development Environment
#
# This Docker Compose setup supports both SQLite (default) and PostgreSQL databases.
#
# ==============================================================================
# Quick Start
# ==============================================================================
#
# SQLite (default - lightweight, file-based):
#   docker-compose up
#
# PostgreSQL (optional - for multi-user or production-like setup):
#   docker-compose --profile postgres up
#
# Or set in .env file:
#   COMPOSE_PROFILES=postgres
#   docker-compose up
#
# ==============================================================================
# Database Modes
# ==============================================================================
#
# 1. SQLite Mode (default):
#    - No PostgreSQL container runs
#    - Database stored in ~/.agor/agor.db (inside container volume)
#    - Lightweight, perfect for single-user development
#
# 2. PostgreSQL Mode (with --profile postgres):
#    - PostgreSQL container runs automatically
#    - Database in postgres-data volume
#    - Better for multi-user scenarios or testing production setup
#    - Set DATABASE_URL or it auto-connects to postgres:5432
#
# ==============================================================================
# Configuration
# ==============================================================================
#
# Copy .env.example to .env and customize:
#   cp .env.example .env
#
# Key environment variables:
#   AGOR_DB_DIALECT      - 'sqlite' (default) or 'postgresql'
#   DATABASE_URL         - Full PostgreSQL connection URL (when using PostgreSQL)
#   POSTGRES_DB          - Database name (default: agor)
#   POSTGRES_USER        - Database user (default: agor)
#   POSTGRES_PASSWORD    - Database password (default: agor_dev_secret)
#
# ==============================================================================

services:
  agor-dev:
    image: agor-dev
    build:
      context: .
      dockerfile: docker/Dockerfile
      target: development
    # No container_name - allows multiple instances via docker compose -p flag
    ports:
      # Expose daemon port (so browser can connect) - configurable via DAEMON_PORT
      - '${DAEMON_PORT:-3030}:${DAEMON_PORT:-3030}'
      # Expose UI port (configurable via UI_PORT env var)
      - '${UI_PORT:-5173}:${UI_PORT:-5173}'
    environment:
      # Daemon configuration
      - NODE_ENV=development
      - DAEMON_PORT=${DAEMON_PORT:-3030}
      - CORS_ORIGIN=${CORS_ORIGIN:-}

      # UI configuration
      - UI_PORT=${UI_PORT:-5173}
      # UI connects to daemon via localhost (inside container)
      - VITE_DAEMON_PORT=${DAEMON_PORT:-3030}

      # Database configuration (SQLite by default, PostgreSQL with --profile postgres)
      - AGOR_DB_DIALECT=${AGOR_DB_DIALECT:-sqlite}
      # DATABASE_URL for PostgreSQL (auto-connects to postgres container if profile is active)
      # Override in .env for custom connection string
      - DATABASE_URL=${DATABASE_URL:-postgresql://${POSTGRES_USER:-agor}:${POSTGRES_PASSWORD:-agor_dev_secret}@postgres:5432/${POSTGRES_DB:-agor}}

      # Seed development fixtures (optional, set SEED=true to populate test data)
      # Creates: Agor repo (https://github.com/preset-io/agor.git) + test-worktree
      - SEED=${SEED:-false}

      # Pass through API keys from host (if set)
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}
    depends_on:
      postgres:
        condition: service_healthy
        required: false  # Optional dependency - only needed when postgres profile is active
    volumes:
      # Mount entire repo for hot-reload (but exclude node_modules and build outputs)
      - .:/app
      # Exclude all node_modules directories (use container's versions)
      - /app/node_modules
      - /app/apps/agor-daemon/node_modules
      - /app/apps/agor-cli/node_modules
      - /app/apps/agor-ui/node_modules
      - /app/packages/core/node_modules
      # Exclude @agor/core build output (built fresh in container during entrypoint)
      # This prevents empty/stale host dist from overwriting container's fresh build
      - /app/packages/core/dist
      # Persist entire home directory (database, config, agent auth tokens, etc.)
      - agor-home:/home/agor
      # Mount SSH keys for git authentication (dev only)
      - ~/.ssh:/home/agor/.ssh:ro
    stdin_open: true
    tty: true

  # PostgreSQL database (ONLY active with --profile postgres)
  # Usage: docker-compose --profile postgres up
  postgres:
    profiles: ["postgres"]  # Optional service - only runs when profile is specified
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-agor}
      POSTGRES_USER: ${POSTGRES_USER:-agor}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-agor_dev_secret}
      # Performance tuning for development
      POSTGRES_INITDB_ARGS: "-E UTF8 --locale=C"
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-agor} -d ${POSTGRES_DB:-agor}"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s
    restart: unless-stopped

volumes:
  # Named volume - unique per docker-compose project
  # Use -p flag to create separate volumes per worktree
  # Persists: database, config, agent auth tokens, caches, etc.
  agor-home:

  # PostgreSQL data (only created when postgres profile is active)
  postgres-data:
